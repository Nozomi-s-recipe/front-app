name: CI/CD pipeline for noz-front-app

on:
  push:
    branches:
      - main
  # webhook from micro-cms
  repository_dispatch:
    types: [micro-cms-add-new-recipe-event]

jobs:
  build-and-deploy:
    name: Build and Deploy to Google Cloud Run
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: asia-east1-docker.pkg.dev/nozomi-recipe/nozomi-recipe/noz-front-app:latest
      IMAGE_REPO_REGION: asia-east1-docker.pkg.dev
      SERVICE_NAME: noz-front-app
      REGION: asia-east1
      PROJECT: nozomi-recipe

    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build in Github
        env:
          MICROCMS_SERVICE_DOMAIN: ${{ vars.MICROCMS_SERVICE_DOMAIN }}
          MICROCMS_API_KEY: ${{ secrets.MICROCMS_API_KEY }}
          HASURA_BACKEND_URL: ${{ vars.HASURA_BACKEND_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
        run: |
          # ビルド前に環境変数の存在確認（デバッグ用）
          echo "Checking build args..."
          echo "MICROCMS_SERVICE_DOMAIN exists: $([[ ! -z "$MICROCMS_SERVICE_DOMAIN" ]] && echo 'Yes' || echo 'No')"
          echo "MICROCMS_API_KEY exists: $([[ ! -z "$MICROCMS_API_KEY" ]] && echo 'Yes' || echo 'No')"
          echo "NEXT_PUBLIC_SUPABASE_URL exists: $([[ ! -z "$NEXT_PUBLIC_SUPABASE_URL" ]] && echo 'Yes' || echo 'No')"
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY exists: $([[ ! -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]] && echo 'Yes' || echo 'No')"
          echo "NEXT_PUBLIC_GOOGLE_CLIENT_ID exists: $([[ ! -z "$NEXT_PUBLIC_GOOGLE_CLIENT_ID" ]] && echo 'Yes' || echo 'No')"

          docker build --no-cache -t $IMAGE_NAME \
            --build-arg MICROCMS_SERVICE_DOMAIN="$MICROCMS_SERVICE_DOMAIN" \
            --build-arg MICROCMS_API_KEY="$MICROCMS_API_KEY" \
            --build-arg NEXT_PUBLIC_SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL" \
            --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="$NEXT_PUBLIC_SUPABASE_ANON_KEY" \
            --build-arg NEXT_PUBLIC_GOOGLE_CLIENT_ID="$NEXT_PUBLIC_GOOGLE_CLIENT_ID" \
            --progress=plain \
            .

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCLOUD_SERVICE_ACCOUNT_JSON }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Set Google Cloud Project
        run: gcloud config set project $PROJECT
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_JSON }}

      - name: Log in to Google Artifact Registry
        run: gcloud auth configure-docker $IMAGE_REPO_REGION
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_JSON }}

      - name: Push to Google Artifact Registry
        run: |
          docker push $IMAGE_NAME

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE_NAME \
          --image $IMAGE_NAME \
          --region $REGION \
          --allow-unauthenticated \
          --min-instances 0 \
          --max-instances 5 \
          --memory 512Mi \
          --cpu 1 \
          --update-env-vars MICROCMS_SERVICE_DOMAIN=${{ vars.MICROCMS_SERVICE_DOMAIN }},MICROCMS_API_KEY=${{ secrets.MICROCMS_API_KEY }},HASURA_BACKEND_URL=${{ vars.HASURA_BACKEND_URL }},NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }},NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }},NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_JSON }}
